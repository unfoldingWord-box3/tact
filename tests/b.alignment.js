// tests/aligner.js
var chai = require('chai')
var assert = chai.assert
var tact = require('./../tact/tact.js')
var options = require('config').Client

function reverse(s) {
  return s.split('').reverse().join('')
}

describe('Alignment Object', function() {
  it('ratioScore() should calculate ratios from tallies', function() {
    var alignment = new tact.Alignment(options, 'a', 'b')
    alignment.addTally(2)
    alignment.addLocalTotals(3,3)
    alignment.addGlobalTotals(9,9)
    alignment.ratioScore()
    assert.isAtLeast(alignment.ratios.localSource, 0)
    assert.isAtMost(alignment.ratios.localSource, 1)
    assert.isAtLeast(alignment.ratios.globalSource, 0)
    assert.isAtMost(alignment.ratios.globalSource, 1)
    assert.isAtLeast(alignment.scores.ratio, 0)
    assert.isAtMost(alignment.scores.ratio, 1)
  })
  it('uniquenessScore() should calculate ratios from tallies', function() {
    var alignment = new tact.Alignment(options, 'a', 'b')
    alignment.addTally(2)
    alignment.addLocalTotals(3,3)
    alignment.addGlobalTotals(9,9)
    alignment.ratioScore()
    alignment.uniquenessScore()
    assert.isAtLeast(alignment.uniqueness.source, 0)
    assert.isAtMost(alignment.uniqueness.source, 1)
  })
  it('ngramScore() should calculate score from ngrams', function() {
    var alignment = new tact.Alignment(options, 'a', 'b')
    alignment.ngramScore()
    assert.isAtLeast(alignment.scores.ngram, 0)
    assert.isAtMost(alignment.scores.ngram, 1)
    alignment.ngramScore()
    assert.isAtLeast(alignment.scores.ngram, 0)
    assert.isAtMost(alignment.scores.ngram, 1)
  })
  it('phraseCountScore() should calculate score', function() {
    var alignmentPair = [['a', 'b', 'd', 'c'], ['c', 'b', 'a', 'd']]
    var alignment = new tact.Alignment(options, 'a', 'b')
    var phraseCountScore = alignment.phraseCountScore(alignmentPair[0], alignmentPair[1])
    assert.isAtLeast(phraseCountScore, 0)
    assert.isAtMost(phraseCountScore, 1)
    var alignment = new tact.Alignment(options, 'a b d', 'b a d')
    var phraseCountScore = alignment.phraseCountScore(alignmentPair[0], alignmentPair[1])
    assert.isAtLeast(phraseCountScore, 0)
    assert.isAtMost(phraseCountScore, 1)
  })
  it('wordOrderScore() should calculate score', function() {
    var alignmentPair = ['a b d c', 'c b a d']
    var alignment = new tact.Alignment(options, 'a', 'b')
    var wordOrderScore = alignment.wordOrderScore(alignmentPair[0], alignmentPair[1])
    assert.isAtLeast(wordOrderScore, 0)
    assert.isAtMost(wordOrderScore, 1)
    var alignment = new tact.Alignment(options, 'a b d', 'b a d')
    var wordOrderScore = alignment.wordOrderScore(alignmentPair[0], alignmentPair[1])
    assert.isAtLeast(wordOrderScore, 0)
    assert.isAtMost(wordOrderScore, 1)
    var alignmentPair = ['a b, d c', 'c b-a d']
    var alignment = new tact.Alignment(options, 'a b d', 'b a d')
    var wordOrderScore = alignment.wordOrderScore(alignmentPair[0], alignmentPair[1])
    assert.isAtLeast(wordOrderScore, 0)
    assert.isAtMost(wordOrderScore, 1)
  })
  it('sizeDeltaScore() should calculate score', function() {
    var alignmentPair = ['a b d c', 'c b a d']
    var alignment = new tact.Alignment(options, 'a', 'b')
    var sizeDeltaScore = alignment.sizeDeltaScore(alignmentPair[0], alignmentPair[1])
    assert.isAtLeast(sizeDeltaScore, 0)
    assert.isAtMost(sizeDeltaScore, 1)
    var alignment = new tact.Alignment(options, 'a b d', 'b a d')
    var sizeDeltaScore = alignment.sizeDeltaScore(alignmentPair[0], alignmentPair[1])
    assert.isAtLeast(sizeDeltaScore, 0)
    assert.isAtMost(sizeDeltaScore, 1)
    var alignmentPair = ['a b, d c', 'c b-a d']
    var alignment = new tact.Alignment(options, 'a b d', 'b a d')
    var sizeDeltaScore = alignment.sizeDeltaScore(alignmentPair[0], alignmentPair[1])
    assert.isAtLeast(sizeDeltaScore, 0)
    assert.isAtMost(sizeDeltaScore, 1)
  })
  it('score() should calculate score', function() {
    var alignmentPair = ['a b d c', 'c b a d']
    var alignment = new tact.Alignment(options, 'a', 'b')
    alignment.addTally(2)
    alignment.addLocalTotals(3,3)
    alignment.addGlobalTotals(9,9)
    alignment.score(alignmentPair)
    assert.isAtLeast(alignment.confidence, 0)
    assert.isAtMost(alignment.confidence, 1)
    var alignment = new tact.Alignment(options, 'a b d', 'b a d')
    alignment.addTally(2)
    alignment.addLocalTotals(3,3)
    alignment.addGlobalTotals(9,9)
    alignment.score(alignmentPair)
    assert.isAtLeast(alignment.confidence, 0)
    assert.isAtMost(alignment.confidence, 1)
    var alignmentPair = ['a b, d c', 'c b-a d']
    var alignment = new tact.Alignment(options, 'a b d', 'b a d')
    alignment.addTally(2)
    alignment.addLocalTotals(3,3)
    alignment.addGlobalTotals(9,9)
    alignment.score(alignmentPair)
    assert.isAtLeast(alignment.confidence, 0)
    assert.isAtMost(alignment.confidence, 1)
  })
  it('isNeeded() should update alignments', function() {
    var alignment = new tact.Alignment(options, 'a', 'b')
    alignment.isNeeded('z', alignment.target)
    assert.isNotTrue(alignment.sourceNeeded)
    assert.isTrue(alignment.targetNeeded)
    alignment = new tact.Alignment(options, 'a', 'b')
    alignment.isNeeded(alignment.source, 'y')
    assert.isTrue(alignment.sourceNeeded)
    assert.isNotTrue(alignment.targetNeeded)
    alignment = new tact.Alignment(options, 'a', 'b')
    alignment.isNeeded('z', 'y')
    assert.isNotTrue(alignment.sourceNeeded)
    assert.isNotTrue(alignment.targetNeeded)
  })
  it('isNeeded() should not update where target is " " alignments', function() {
    var alignment = new tact.Alignment(options, 'a', ' ')
    alignment.isNeeded('z', 'y')
    assert.isNotTrue(alignment.sourceNeeded)
    assert.isTrue(alignment.targetNeeded)
    alignment = new tact.Alignment(options, ' ', 'b')
    alignment.isNeeded('z', 'y')
    assert.isTrue(alignment.sourceNeeded)
    assert.isNotTrue(alignment.targetNeeded)
    alignment = new tact.Alignment(options, ' ', ' ')
    alignment.isNeeded('z', 'y')
    assert.isTrue(alignment.sourceNeeded)
    assert.isTrue(alignment.targetNeeded)
  })
})
